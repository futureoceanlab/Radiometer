#include <Arduino.h>

#define ESTCUTOFF_LIN 1
#define ESTCUTOFF_LOW 20
#define ESTCUTOFF_HIGH 70

#define INVLUTSTEP 10
#define LUTSTEP 0.1F
#define LUTOFFSET_LOW 5
#define LUTOFFSET_HIGH 0

const float invLUT_lowPulses[2][91] {
{   148745,    158781,    168817,    178854,    188890,    198926,    208963,    218999,    229035,    239072,
    249106,    259033,    268796,    278412,    287897,    297261,    306516,    315672,    324738,    333721,
    342629,    351468,    360244,    368963,    377630,    386250,    394826,    403364,    411867,    420338,
    428781,    437200,    445597,    453975,    462337,    470685,    479023,    487352,    495675,    503994,
    512311,    520628,    528944,    537260,    545576,    553892,    562208,    570524,    578840,    587157,
    595474,    603792,    612111,    620430,    628750,    637071,    645392,    653714,    662036,    670360,
    678685,    687013,    695345,    703682,    712026,    720377,    728737,    737107,    745487,    753880,
    762286,    770707,    779143,    787595,    796064,    804553,    813061,    821590,    830139,    838710,
    847299,    855905,    864527,    873163,    881812,    890472,    899141,    907819,    916502,    925191,
    933883},
{   933883,   1020687,   1107210,   1194453,   1282740,   1371565,   1460527,   1549400,   1638393,   1728079,
   1819060,   1911913,   2006902,   2104051,   2202954,   2303054,   2403780,   2504587,   2604973,   2704682,
   2804366,   2903894,   3002826,   3100779,   3197432,   3292754,   3387404,   3482100,   3577520,   3674196,
   3772263,   3871765,   3972760,   4075319,   4179486,   4285345,   4392944,   4502352,   4613509,   4726218,
   4840278,   4955474,   5071580,   5188364,   5305738,   5423922,   5543039,   5663171,   5784415,   5906839,
   6030556,   6155637,   6282209,   6410348,   6540182,   6671825,   6805387,   6941015,   7078854,   7218971,
   7361360,   7506024,   7653029,   7802537,   7954741,   8109854,   8268129,   8429821,   8595198,   8764572,
   8938244,   9116491,   9299475,   9487432,   9680710,   9879499,  10084145,  10295086,  10513048,  10738920,
  10973849,  11219066,  11476212,  11747216,  12034385,  12340679,  12670296,  13028720,  13424325,  13869992,
  14389117}
};

const float invLUT_hiPulses[7][91] {
    {188094838, 187053783, 186113741, 185259246, 184476676, 183754076, 183080983, 182448273, 181868570, 181318757,
    180790224, 180307084, 179836444, 179395467, 178970725, 178568280, 178179078, 177811837, 177449267, 177114183,
    176779099, 176464906, 176159188, 175854973, 175576066, 175297158, 175022139, 174767704, 174513270, 174258835,
    174026682, 173794583, 173562483, 173341552, 173129832, 172918112, 172706392, 172509245, 172316117, 172122989,
    171929862, 171748201, 171572032, 171395864, 171219695, 171046523, 170885822, 170725120, 170564419, 170403717,
    170247282, 170100685, 169954088, 169807491, 169660894, 169514297, 169380114, 169246377, 169112641, 168978904,
    168845167, 168713093, 168591081, 168469069, 168347057, 168225045, 168103033, 167981021, 167867430, 167756106,
    167644783, 167533459, 167422135, 167310812, 167199488, 167096504, 166994924, 166893343, 166791762, 166690181,
    166588600, 166487020, 166388051, 166295351, 166202650, 166109950, 166017249, 165924549, 165831848, 165739148,
    165646820},
    {165646820, 164808501, 164044541, 163342809, 162699005, 162104815, 161548283, 161022006, 160531308, 160071218,
    159625899, 159216003, 158816327, 158441552, 158077747, 157734989, 157398714, 157085146, 156771577, 156482356,
    156195403, 155918281, 155655598, 155392916, 155145199, 154904655, 154664111, 154437902, 154217563, 153997223,
    153785844, 153583948, 153382052, 153180156, 152994828, 152809771, 152624714, 152442438, 152272759, 152103079,
    151933399, 151764453, 151608818, 151453183, 151297548, 151141914, 150993613, 150850809, 150708005, 150565200,
    150422396, 150287927, 150156846, 150025765, 149894685, 149763604, 149637236, 149516870, 149396504, 149276139,
    149155773, 149035407, 148922153, 148811585, 148701017, 148590449, 148479880, 148369312, 148263532, 148161926,
    148060321, 147958715, 147857110, 147755504, 147653899, 147559077, 147465673, 147372268, 147278863, 147185459,
    147092054, 146998649, 146909486, 146823587, 146737688, 146651789, 146565890, 146479991, 146394092, 146308193,
    146227135},
    {146227135, 145450700, 144740647, 144087078, 143481362, 142915985, 142391848, 141900981, 141434906, 140989016,
    140577172, 140178958, 139798566, 139439495, 139087985, 138760677, 138435697, 138133786, 137833186, 137551199,
    137273008, 137006257, 136748677, 136493157, 136254544, 136015932, 135785697, 135564543, 135343390, 135132794,
    134927720, 134722645, 134526843, 134336580, 134146317, 133961167, 133784554, 133607942, 133431330, 133265891,
    133101864, 132937837, 132775560, 132623140, 132470720, 132318300, 132167461, 132025751, 131884040, 131742330,
    131600619, 131467428, 131335603, 131203778, 131071953, 130942646, 130819953, 130697260, 130574567, 130451874,
    130332313, 130218063, 130103812, 129989562, 129875311, 129762060, 129655618, 129549176, 129442734, 129336291,
    129229849, 129127208, 129027991, 128928774, 128829556, 128730339, 128631122, 128535543, 128443013, 128350483,
    128257954, 128165424, 128072894, 127981350, 127895013, 127808677, 127722340, 127636004, 127549667, 127463330,
    127378988},
    {127378988, 126589403, 125862946, 125191920, 124569493, 123989611, 123446908, 122936619, 122454519, 121996866,
    121560344, 121143877, 120751139, 120372269, 120005224, 119660290, 119323675, 118999583, 118689075, 118384324,
    118096002, 117809529, 117539708, 117269994, 117015942, 116761890, 116520899, 116281591, 116051175, 115825659,
    115603723, 115391114, 115178506, 114975297, 114774772, 114575831, 114386625, 114197420, 114012000, 113833400,
    113654801, 113480400, 113311743, 113143086, 112977495, 112818162, 112658829, 112500104, 112349519, 112198934,
    112048349, 111902992, 111760618, 111618244, 111476043, 111341380, 111206717, 111072053, 110938975, 110811555,
    110684135, 110556714, 110430775, 110310162, 110189548, 110068935, 109948385, 109834171, 109719957, 109605744,
    109491530, 109380848, 109272653, 109164459, 109056264, 108948069, 108845193, 108742662, 108640130, 108537599,
    108435373, 108338172, 108240972, 108143771, 108046570, 107949369, 107856844, 107764663, 107672482, 107580301,
    107488119},
    {107488119, 106628877, 105839498, 105110853, 104434065, 103803700, 103210557, 102651209, 102123331, 101623950,
    101148674, 100695260, 100261656,  99847517,  99450914,  99069545,  98701910,  98346641,  98002956,  97674192,
      97354626,  97043271,  96743411,  96452517,  96167466,  95893231,  95625177,  95362796,  95109926,  94859883,
      94619467,  94381974,  94151733,  93925388,  93704824,  93488348,  93276990,  93069221,  92866622,  92666502,
      92472241,  92278807,  92092484,  91906161,  91726099,  91547337,  91371936,  91200375,  91028935,  90864237,
      90699539,  90537969,  90379813,  90221656,  90068775,  89916856,  89765637,  89619667,  89473697,  89329382,
      89189087,  89048792,  88910474,  88775595,  88640716,  88507566,  88377857,  88248148,  88119416,  87994643,
      87869870,  87745098,  87624814,  87504756,  87384698,  87267318,  87151764,  87036211,  86921182,  86809933,
      86698684,  86587435,  86478373,  86371239,  86264105,  86156972,  86053065,  85949866,  85846666,  85743467,
      85643975},
    { 85643975,  84684988,  83803466,  82989996,  82232982,  81525015,  80861073,  80234266,  79639493,  79077334,
      78539785,  78028997,  77538646,  77069243,  76619102,  76185369,  75767056,  75363408,  74974500,  74598050,
      74233320,  73879619,  73536296,  73202741,  72878382,  72562680,  72255129,  71955255,  71663074,  71378456,
      71100376,  70828452,  70562327,  70301662,  70046979,  69798212,  69554057,  69314239,  69079136,  68849488,
      68623476,  68400884,  68183434,  67969553,  67758518,  67551875,  67348651,  67147775,  66951234,  66757368,
      66565631,  66378331,  66192680,  66010087,  65830336,  65652094,  65477865,  65304731,  65134775,  64966608,
      64800597,  64637081,  64474889,  64315729,  64157236,  64002153,  63847414,  63695979,  63544918,  63396849,
      63249233,  63104426,  62960036,  62818392,  62677020,  62538444,  62399898,  62264296,  62128694,  61995676,
      61862959,  61732327,  61602409,  61474007,  61346804,  61220485,  61095916,  60971542,  60849531,  60727519,
      60607443},
    { 60607443,  59457758,  58395967,  57408049,  56484239,  55614472,  54793552,  54014602,  53273088,  52565060,
      51887074,  51236751,  50611145,  50007630,  49425233,  48861279,  48315108,  47784507,  47269246,  46767586,
      46278569,  45801764,  45336206,  44881017,  44435582,  43999332,  43571735,  43152464,  42740859,  42336487,
      41938953,  41547890,  41162953,  40783808,  40410127,  40041600,  39677933,  39318854,  38964107,  38613445,
      38266638,  37923462,  37583708,  37247171,  36913657,  36583010,  36255010,  35929474,  35606227,  35285095,
      34965911,  34648511,  34332739,  34018443,  33705474,  33393685,  33082930,  32773060,  32463914,  32155312,
      31847078,  31539017,  31230935,  30922635,  30613910,  30304548,  29994312,  29682933,  29370200,  29055877,
      28739576,  28421091,  28099999,  27775919,  27448391,  27117011,  26781022,  26439963,  26093078,  25739496,
      25378210,  25008053,  24627600,  24234630,  23827010,  23401407,  22953684,  22478245,  21966677,  21405612,
      20771989}
};

const float invLUT_midTimeHi[101] {
     50685,    573112,   1031468,   1482359,   1930890,   2379001,   2814675,   3233276,   3637278,   4032849,
   4422451,   4807281,   5187081,   5561629,   5931495,   6297186,   6659130,   7017695,   7373165,   7725646,
   8075402,   8422739,   8767943,   9111239,   9452770,   9792654,  10130999,  10467982,  10803909,  11139070,
  11473740,  11808151,  12142495,  12476951,  12811690,  13146878,  13482674,  13819231,  14156716,  14495307,
  14835181,  15176503,  15519450,  15864187,  16210874,  16559676,  16910806,  17264420,  17620780,  17980043,
  18342449,  18708229,  19077574,  19450716,  19827919,  20209464,  20595598,  20986613,  21382816,  21784523,
  22192064,  22605803,  23026125,  23453448,  23888219,  24330922,  24782085,  25242288,  25712161,  26192365,
  26683627,  27186745,  27702604,  28232187,  28776588,  29337139,  29915220,  30512226,  31129775,  31770196,
  32435201,  33127846,  33850720,  34607410,  35402198,  36239623,  37125793,  38067318,  39072786,  40152893,
  41321553,  42596077,  44000348,  45566437,  47340686,  49395582,  51844694,  54894147,  58975940,  65292825,
  91755864
}

int logfloor (uint32_t n) {
    if (n < 10) return 0;
    if (n < 100) return 1;
    if (n < 1000) return 2;
    if (n < 10000) return 3;
    if (n < 100000) return 4;
    if (n < 1000000) return 5;
    if (n < 10000000) return 6;
    if (n < 100000000) return 7;
    if (n < 1000000000) return 8;
    /*      2147483647 is 2^31-1 - add more ifs as needed
       and adjust this final return as well. */
    return 10;
}

uint32_t LinInterpFixed(float mantissa, const float *LUT) {
  static int LUTindex;
  static float slope, remainder, estimate;
  LUTindex = floorf(INVLUTSTEP*(mantissa-1.F));
  slope = (LUT[LUTindex+1] - LUT[LUTindex])*INVLUTSTEP;
  remainder = mantissa - 1 - LUTindex*LUTSTEP; 
  estimate = LUT[LUTindex] + slope*remainder;
  return static_cast<uint32_t>(estimate+0.5F);
}

uint32_t Photon_Estimator(uint32_t pulses, uint32_t timeHi, int logfreq) {
  static uint32_t photon_estimate;
  static int decade, LUTblock;
  static float mantissa;
  static float pctTimeHi; 
  
  pctTimeHi= 16*timeHi*pow10f((float) logfreq - 7.F); //TODO: Explain this
  if (pctTimeHi < ESTCUTOFF_LIN) {
    photon_estimate = pulses;
  }
  else if (pctTimeHi < ESTCUTOFF_LOW) {
    decade = logfloor(pulses);
    mantissa = pulses/powf(10.F, (float) decade);
    LUTblock = decade + logfreq - LUTOFFSET_LOW;
    photon_estimate = LinInterpFixed(mantissa, invLUT_lowPulses[LUTblock]);
  }
  else if (pctTimeHi < ESTCUTOFF_HIGH) {
    mantissa = 1.F + pctTimeHi/10.F;
    photon_estimate = LinInterpFixed(mantissa, invLUT_midTimeHi);
  }
  else {
    decade = logfloor(pulses);
    mantissa = pulses/powf(10.F, (float) decade);
    LUTblock = decade + logfreq - LUTOFFSET_HIGH;
    photon_estimate = LinInterpFixed(mantissa, invLUT_hiPulses[LUTblock]);
  }
  return photon_estimate;
}
